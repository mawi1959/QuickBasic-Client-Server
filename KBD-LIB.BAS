DECLARE FUNCTION COUNT.SPACES! (YY$)
DECLARE FUNCTION HEX.TO.DECIMAL! (HX$)
'靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
' File Id.  ............ KBD-LIB.BAS                                          
' Author ............... Muawiya Abujubain COVENTRY GROUP LTD.                
'                                                                             
' Purpose  ............. This file includes routines that are called by       
'                        program SCR-CNFG.BAS & SCR-MNGR.BAS. The routines    
'                        handle keyboard input.                               
'聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

FUNCTION COUNT.SPACES (YY$)

	FOR I1 = 1 TO LEN(YY$)
	   IF MID$(YY$, I1, 1) <> " " THEN
	      I1 = I1 - 1
	      COUNT.SPACES = I1
	      EXIT FUNCTION
	   END IF
	NEXT I1
	COUNT.SPACES = I1

END FUNCTION

FUNCTION HEX.TO.DECIMAL (HX$)

	H8$ = "0123456789ABCDEF"
	DEC = 0
	FOR I8 = 1 TO LEN(HX$)
	   DEC = INSTR(H8$, MID$(HX$, I8, 1)) - 1 + 16 * DEC
	NEXT I8
	HEX.TO.DECIMAL = DEC

END FUNCTION

SUB PROCESS.DELETE.KEY (POZ, CT$(), CURRENT.FIELD, SIROW(), SICOL(), SILEN(), F$, X, Y)

	IF POZ > LEN(CT$(CURRENT.FIELD)) THEN
	   BEEP
	   EXIT SUB
	END IF

	IF POZ = 1 THEN
	   CT$(CURRENT.FIELD) = RIGHT$(CT$(CURRENT.FIELD), LEN(CT$(CURRENT.FIELD)) - 1)
	ELSE
	   L1 = POZ - 1
	   L2 = LEN(CT$(CURRENT.FIELD)) - POZ
	   X1$ = LEFT$(CT$(CURRENT.FIELD), L1)
	   X2$ = RIGHT$(CT$(CURRENT.FIELD), L2)
	   CT$(CURRENT.FIELD) = X1$ + X2$
	END IF

	LOCATE SIROW(CURRENT.FIELD), SICOL(CURRENT.FIELD), 0
	X$ = STRING$(SILEN(CURRENT.FIELD) - LEN(CT$(CURRENT.FIELD)), F$)
	CT$(CURRENT.FIELD) = RTRIM$(CT$(CURRENT.FIELD))
	PRINT CT$(CURRENT.FIELD); X$;
	LOCATE X, Y, 1, 0, 31

END SUB

SUB PROCESS.DOWN.ARROW (SIROW(), SICOL(), CURRENT.FIELD, FEELDS)
		 
	DOWN.OK = 0
	CURRENT.ROW = SIROW(CURRENT.FIELD)
	CURRENT.COL = SICOL(CURRENT.FIELD)

	FOR I8 = CURRENT.FIELD TO FEELDS
	   IF SIROW(I8) > CURRENT.ROW AND SICOL(I8) = CURRENT.COL THEN
	      CURRENT.FIELD = I8 - 1
	      I8 = FEELDS + 1
	      DOWN.OK = 1
	   END IF
	NEXT I8

	IF DOWN.OK = 0 THEN
	   FOR I8 = CURRENT.FIELD TO FEELDS
	      IF SIROW(I8) > CURRENT.ROW THEN
		 CURRENT.FIELD = I8 - 1
		 I8 = FEELDS + 1
		 DOWN.KEY = 1
	      END IF
	   NEXT I8
	END IF

	IF CURRENT.FIELD = FEELDS THEN
	   CURRENT.FIELD = 0
	END IF

END SUB

SUB PROCESS.INSERT.KEY (POZ, CT$(), CURRENT.FIELD, SIROW(), SICOL(), SILEN(), X, Y, L3)

	IF LEN(CT$(CURRENT.FIELD)) = SILEN(CURRENT.FIELD) OR POZ > LEN(CT$(CURRENT.FIELD)) THEN
	   BEEP
	   EXIT SUB
	END IF

	LOCATE SIROW(CURRENT.FIELD), SICOL(CURRENT.FIELD), 0

	IF POZ = 1 THEN
	   PRINT " "; CT$(CURRENT.FIELD);
	   CT$(CURRENT.FIELD) = " " + CT$(CURRENT.FIELD)
	   INS.FLAG = 1
	ELSE
	   L1 = LEN(CT$(CURRENT.FIELD)) - POZ + 1
	   L2 = LEN(CT$(CURRENT.FIELD)) - L1
	   X1$ = LEFT$(CT$(CURRENT.FIELD), L2)
	   X2$ = RIGHT$(CT$(CURRENT.FIELD), L1)
	   CT$(CURRENT.FIELD) = X1$ + " " + X2$
	   PRINT CT$(CURRENT.FIELD);
	END IF

	L3 = L3 + 1
	LOCATE X, Y, 1, 0, 31

END SUB

SUB PROCESS.LEFT.ARROW (CURRENT.FIELD, POZ, SILEN(), SIROW(), SICOL(), L.KEY, RP.KEY, Y, X)

	IF CURRENT.FIELD = 1 AND POZ = 1 THEN
	   EXIT SUB
	END IF

	IF POZ = 1 THEN
	   CURRENT.FIELD = CURRENT.FIELD - 1
	   POZ = SILEN(CURRENT.FIELD)
	   LOCATE SIROW(CURRENT.FIELD), SICOL(CURRENT.FIELD), 1, 0, 31
	   L.KEY = 2
	   EXIT SUB
	END IF

	RP.KEY = 0

	Y = Y - 1
	LOCATE X, Y, 1, 0, 31
	L.KEY = 1

END SUB

SUB PROCESS.PGUP.PGDN.KEY (H.SCREEN, W$, C.SCREEN) STATIC
	     
	IF FIRST.TIME = 0 THEN
	   U.SCREEN = -1
	   D.SCREEN = -1
	   FIRST.TIME = 1
	END IF

	IF RIGHT$(W$, 1) = CHR$(73) THEN
	   GOSUB PGUP.KEY
	   D.SCREEN = U.SCREEN
	ELSE
	   GOSUB PGDN.KEY
	   U.SCREEN = D.SCREEN
	END IF
	EXIT SUB

PGUP.KEY:

	U.SCREEN = U.SCREEN + 1
	IF U.SCREEN > H.SCREEN THEN
	   SCREEN , , , C.SCREEN
	   U.SCREEN = -1
	   RETURN
	END IF
	SCREEN , , , U.SCREEN
	RETURN

PGDN.KEY:

	IF D.SCREEN = -1 THEN
	   D.SCREEN = H.SCREEN + 1
	END IF

	D.SCREEN = D.SCREEN - 1

	IF D.SCREEN = -1 THEN
	   SCREEN , , , C.SCREEN
	   RETURN
	END IF
	SCREEN , , , D.SCREEN
	RETURN

END SUB

SUB PROCESS.RIGHT.ARROW (X, Y, R.KEY)

	Y = Y + 1
	LOCATE X, Y, 1, 0, 31
	R.KEY = 1

END SUB

SUB PROCESS.UP.ARROW (SIROW(), SICOL(), CURRENT.FIELD, FEELDS)

	UP.OK = 0
	CURRENT.ROW = SIROW(CURRENT.FIELD)
	CURRENT.COL = SICOL(CURRENT.FIELD)

	FOR I8 = CURRENT.FIELD TO 1 STEP -1
	   IF SIROW(I8) < CURRENT.ROW AND SICOL(I8) = CURRENT.COL THEN
	      CURRENT.FIELD = I8 - 1
	      I8 = 0
	      UP.OK = 1
	   END IF
	NEXT I8

	IF UP.OK = 0 THEN
	   FOR I8 = CURRENT.FIELD TO 1 STEP -1
	      IF SIROW(I8) < CURRENT.ROW THEN
		 CURRENT.FIELD = I8 - 1
		 I8 = 0
		 UP.OK = 1
	      END IF
	   NEXT I8
	END IF

	IF UP.OK = 0 THEN
	   CURRENT.FIELD = FEELDS - 1
	END IF

END SUB

SUB VALIDATE.INPUT (ALLOWED.KEYS$, W$, ERROR.CODE, BACK.TAB$, ASCII$, TYP(), ACCEPT$, HELP$, HOME$, END.KEY$, CURRENT.FIELD)

	X1 = ASC(RIGHT$(W$, 1))
	Y1 = INSTR(ALLOWED.KEYS$, CHR$(X1))
	IF LEN(W$) = 2 AND Y1 > 0 THEN
	   W$ = CHR$(27) + RIGHT$(W$, 1)
	   EXIT SUB
	END IF

	W = INSTR("." + BACK.TAB$ + "0123456789", W$)
	'Compare with the ascii characters.
	Y2 = INSTR(ASCII$, CHR$(X1))

	ON TYP(CURRENT.FIELD) GOTO NUMERIC, ALPHANUM, UPPER

ALPHANUM:

	IF W = 0 AND LEN(W$) = 2 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	IF LEN(W$) = 1 AND Y2 = 0 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	EXIT SUB

NUMERIC:

	IF W$ = CHR$(27) THEN
	   EXIT SUB
	END IF

	IF W$ = ACCEPT$ OR W$ = HELP$ OR W$ = HOME$ OR W$ = END.KEY$ THEN
	   EXIT SUB
	END IF

	IF W = 0 AND LEN(W$) = 2 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	IF LEN(W$) = 1 AND Y2 = 0 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	IF W <> 0 THEN
	   EXIT SUB
	END IF

	ERROR.CODE = 1
	EXIT SUB

UPPER:

	IF W = 0 AND LEN(W$) = 2 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	IF LEN(W$) = 2 AND X1 = 79 AND X1 = 77 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	IF LEN(W$) = 1 AND Y2 = 0 THEN
	   ERROR.CODE = 1
	   EXIT SUB
	END IF

	W$ = UCASE$(W$)

END SUB

